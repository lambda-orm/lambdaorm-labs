# Service - Load Balancer Pentest DDoS (Distributed Denial of Service)

**In this laboratory we will see:**

We will set up a test environment to perform a distributed denial of service (DDoS) attack on a lambdaorm service.
We will configure a docker compose with the following services:

- postgres:database
- orm: lambdaorm service
- nginx: nginx service for load balancing
- prometheus: prometheus service for monitoring
- grafana: grafana service for visualization of metrics

We will execute DDoS attacks using the following tools:

- Slowloris
- GoldenEye

## Install lambda ORM CLI

Install the package globally to use the CLI commands to help you create and maintain projects

```sh
npm install lambdaorm-cli -g
```

## Create project

will create the project folder with the basic structure.

```sh
lambdaorm init -w lab
cd lab
```

## Configure

### Complete Schema

In the schema we will configure:

- Domain
  - Entities
- Infrastructure
  - Default View
  - Mappings of domain entities to database tables
  - Default Source
  - Default Stage
  - Service

In the creation of the project the schema was created but without any entity.
Modify the configuration of lambdaorm.yaml with the following content

```yaml
domain:  
  entities:
  - name: Address
    abstract: true
    indexes:
    - name: postalCode
      fields: ["postalCode"]
    - name: region
      fields: ["region", "country"]
    - name: city
      fields: ["city"]
    properties:
    - name: address
    - name: city
    - name: region
    - name: postalCode
      length: 20
    - name: country
  - name: Categories
    primaryKey: ["id"]
    uniqueKey: ["name"]
    properties:
    - name: id
      type: integer
      required: true
      autoIncrement: true
    - name: name
      required: true
  - name: Customers
    extends: Address
    primaryKey: ["id"]
    indexes:
    - name: name
      fields: ["name"]
    properties:
    - name: id
      length: 5
      required: true
    - name: name
      required: true
  - name: Products
    primaryKey: ["id"]
    uniqueKey: ["name", "supplierId"]
    properties:
    - name: id
      type: integer
      required: true
      autoIncrement: true
    - name: name
      required: true
    - name: categoryId
      type: integer
    - name: quantity
    - name: price
      type: decimal
      default: 0
    relations:
    - name: category
      from: categoryId
      entity: Categories
      to: id
      target: products
  - name: Orders
    primaryKey: ["id"]
    indexes:
    - name: orderDate
      fields: ["orderDate"]
    properties:
    - name: id
      type: integer
      required: true
      autoIncrement: true
    - name: customerId
      required: true
      length: 5
    - name: orderDate
      type: dateTime 
    relations:
    - name: customer
      from: customerId
      entity: Customers
      to: id
      target: orders
  - name: Orders.details
    primaryKey: ["orderId", "productId"]
    properties:
    - name: orderId
      required: true
      type: integer
    - name: productId
      required: true
      type: integer
    - name: unitPrice
      type: decimal
    - name: quantity
      type: decimal
    relations:
    - name: order
      from: orderId
      entity: Orders
      to: id
      target: details
    - name: product
      from: productId
      entity: Products
      to: id
      target: orderDetails
infrastructure:
  views:
  - name: default  
  mappings:
  - name: default
    entities:
    - name: Address
      abstract: true
      properties:
      - name: address
        mapping: Address
      - name: city
        mapping: City
      - name: region
        mapping: Region
      - name: postalCode
        mapping: PostalCode
      - name: country
        mapping: Country
    - name: Categories
      mapping: Categories
      properties:
      - name: id
        mapping: CategoryID
      - name: name
        mapping: CategoryName
    - name: Customers
      extends: Address
      mapping: Customers
      properties:
      - name: id
        mapping: CustomerID
      - name: name
        mapping: CompanyName
    - name: Products
      mapping: Products
      properties:
      - name: id
        mapping: ProductID
      - name: name
        mapping: ProductName
      - name: categoryId
        mapping: CategoryID
      - name: quantity
        mapping: QuantityPerUnit
      - name: price
        mapping: UnitPrice
    - name: Orders
      mapping: Orders
      properties:
      - name: id
        mapping: OrderID
      - name: customerId
        mapping: CustomerID
      - name: orderDate
        mapping: OrderDate
    - name: Orders.details
      mapping: Order Details
      properties:
      - name: orderId
        mapping: OrderID
      - name: productId
        mapping: ProductID
      - name: unitPrice
        mapping: UnitPrice
      - name: quantity
        mapping: Quantity
  sources:    
    - name: default
      mapping: default
      dialect: PostgreSQL
      connection: ${CNN_POSTGRES}    
  stages:
    - name: default
      sources:
        - name: default
  service:
    host: $HOST
    port: $PORT
    requestBodySize: $REQUEST_BODY_SIZE
    rateLimitWindowMs: $RATE_LIMIT_WINDOWS_MS
    rateLimitMax: $RATE_LIMIT_MAX   
```

**Service configuration:**

The following properties were added to the service configuration:

- requestBodySize: which indicates the maximum size of the request body
- rateLimitWindowMs: indicating the time in milliseconds of the time window for the rate limit
- rateLimitMax: which indicates the maximum number of requests per time window

```yaml
...
infrastructure:
  ...
  service:
    host: $HOST
    port: $PORT
    requestBodySize: $REQUEST_BODY_SIZE
    rateLimitWindowMs: $RATE_LIMIT_WINDOWS_MS
    rateLimitMax: $RATE_LIMIT_MAX
...
```

### Add .env file

Create file ".env" with the following content:

```sh
CNN_POSTGRES={"host":"localhost","port":5432,"user":"northwind","password":"northwind","database":"northwind"}
```

### Download file data for import

```sh
wget https://raw.githubusercontent.com/lambda-orm/lambdaorm-labs/main/source/northwind/data.json
```

### Configure Infrastructure

#### NGINX configuration

Add file "nginx.conf" in folder "nginx"

```sh
user  nginx;
events {
    worker_connections   1000;
}
http {
    limit_req_zone $binary_remote_addr zone=one:1m rate=30r/m;
    limit_req_zone $binary_remote_addr zone=two:1m rate=1000r/m;
    limit_conn_zone $binary_remote_addr zone=three:1m;
    server {
        listen 9200;        
        client_header_timeout 2s;
        client_body_timeout 5s;
        location /ping   {
          limit_req zone=one;
          limit_conn three 1;   
          proxy_pass http://orm:9291/ping;
        }
        location /metrics  {
          limit_req zone=two;
          limit_conn three 10;  
          proxy_pass http://orm:9291/metrics;
        }
        location /api-docs  {
          limit_req zone=two;
          limit_conn three 10;  
          proxy_pass http://orm:9291/api-docs;
        }
        location /execute  {
          limit_req zone=two;
          limit_conn three 10;  
          proxy_pass http://orm:9291/execute;
        }        
    }
    # Limit requests size    
    client_body_buffer_size 200K;
    client_header_buffer_size 2k;
    client_max_body_size 200k;
    large_client_header_buffers 3 1k;
    # Compression
    keepalive_timeout 60s;
    gzip on;
    gzip_types text/plain application/json;
    gzip_proxied no-cache no-store private expired auth;
    gzip_min_length 500;
}
```

#### Prometheus configuration

Create folder "prometheus" and file "prometheus.yml"

```yaml
global:
  scrape_interval:     15s
  evaluation_interval: 15s
scrape_configs:
  - job_name: prometheus
    static_configs:
      - targets: ['prometheus:9090']
  - job_name: "node"
    static_configs:
      - targets: ["lambdaorm-lab_orm_1:9291","lambdaorm-lab_orm_2:9291","lambdaorm-lab_orm_3:9291"]
```

#### Grafana configuration

Create folder "grafana/provisioning/datasources"  and file "datasources.yml"

```yaml
apiVersion: 1
datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    orgId: 1
    url: http://prometheus:9090
    basicAuth: false
    isDefault: true
    editable: true
```

Create folder "grafana/provisioning/dashboards"  and file "dashboard.yml"

```yaml
apiVersion: 1
providers:
- name: 'Prometheus'
  orgId: 1
  folder: ''
  type: file
  disableDeletion: false
  editable: true
  options:
    path: /etc/grafana/provisioning/dashboards
```

download the following dashboard file and add in folder "grafana/provisioning/dashboards":

```sh
wget https://raw.githubusercontent.com/lambda-orm/lambdaorm-labs/main/source/grafana/nodejs_application_dashboard.json
```

#### Configure docker compose

Configure docker compose to create the following containers:

- postgres: database
- orm: lambdaorm service
- prometheus: prometheus service
- grafana: grafana service
- nginx: nginx service

```yaml
version: "3"
networks:
  backend:
  frontend:
services:
  postgres:
    container_name: postgres
    image: postgres:12-alpine
    restart: always
    environment:
      - POSTGRES_DB=northwind    
      - POSTGRES_USER=northwind
      - POSTGRES_PASSWORD=northwind
    ports:
      - 5432:5432  
    networks:
      - backend
    healthcheck:
      test: [ "CMD", "pg_isready", "-U", "northwind" ]
      interval: 3s
      timeout: 1s
      retries: 10  
  orm:
    depends_on:
      - postgres
    image: flaviorita/lambdaorm-svc:0.8.52
    restart: always
    deploy:
      replicas: 3
      resources:        
        limits:
          cpus: '0.25'
          memory: 1G
        reservations:
          cpus: '0.1'
          memory: 500M    
    environment:
      HOST: http://0.0.0.0
      PORT: 9291
      NODE_ENV: production
      REQUEST_BODY_SIZE: 100mb
      RATE_LIMIT_WINDOWS_MS: 60000
      RATE_LIMIT_MAX: 1000
      WORKSPACE: /workspace
      CNN_POSTGRES: '{"host":"postgres","port":5432,"user":"northwind","password":"northwind","database":"northwind"}'
    networks:
      - frontend
      - backend
    volumes:
      - ./:/workspace      
    healthcheck:
      test: curl --fail http://localhost:9291/health || exit 1
      interval: 10s
      retries: 3
      start_period: 30s
      timeout: 5s
  nginx:
    depends_on:
      - orm  
    container_name: nginx
    image: nginx:latest     
    ports:
      - 9200:9200
    expose:
      - 9200  
    networks:
      - backend
      - frontend
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro        
  prometheus:
    depends_on:
      - orm
    image: prom/prometheus:v2.20.1
    container_name: prometheus
    volumes:
      - ./prometheus:/etc/prometheus      
    ports:
      - 9090:9090
    expose:
      - 9090
    networks:
      - backend
      - frontend
  grafana:
    depends_on:
      - prometheus
    image: grafana/grafana:7.1.5
    container_name: grafana    
    environment:
      - GF_AUTH_DISABLE_LOGIN_FORM=true
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    ports:
      - 3000:3000
    expose:
      - 3000
    networks:
      - frontend
    volumes:      
      - ./grafana/provisioning:/etc/grafana/provisioning   
```

### Structure of the project

```sh
├── orm_state
├── orm_state.json
├── docker compose.yaml
├── .env
├── grafana
│   └── provisioning
│       ├── dashboards
│       │   ├── dashboard.yml
│       │   └── nodejs_application_dashboard.json
│       └── datasources
│           └── datasources.yml
├── lambdaORM.yaml
├── nginx
│   └── nginx.conf
└── prometheus
    └── prometheus.yml
```

## Start

Create infrastructure , create tables in database and populate data

```sh
# create infrastructure
docker compose -p "lambdaorm-lab" up -d
# create tables in database
lambdaorm push -e .env
# populate data
lambdaorm import -e .env -d ./data.json 
```

## Endpoints

- [metrics](http://localhost:9200/metrics)
- [Prometheus](http://localhost:9090)
- [Grafana](http://localhost:3000)
  - Dashboards
    - [NodeJS Application Dashboard](http://localhost:3000/d/PTSqcpJWk/nodejs-application-dashboard?orgId=1&refresh=5s)

## Service endpoints

### Ping

```sh
curl -X GET "http://localhost:9200/ping?format=beautiful"
```

Result:

```json
{
  "message": "pong",
  "time": "2023-12-12T00:50:36.379Z"
}
```

### Execute

```sh
curl -X POST "http://localhost:9200/execute?format=beautiful" -H "Content-Type: application/json" -d '{"query": "Orders.filter(p=>p.customerId==customerId).include(p=>[p.details.include(p=>p.product.map(p=>p.name)).map(p=>{subTotal:p.quantity*p.unitPrice}),p.customer.map(p=>p.name)]).order(p=>p.orderDate).page(1,1)","data":"{\"customerId\": \"CENTC\"}"}'
```

Result:

```json
[
  {
    "id": 12,
    "customerId": "CENTC",
    "orderDate": "1996-07-18T00:00:00.000Z",
    "details": [
      {
        "subTotal": 80,
        "product": {
          "name": "Sir Rodney's Scones"
        }
      },
      {
        "subTotal": 20.8,
        "product": {
          "name": "Gravad lax"
        }
      }
    ],
    "customer": {
      "name": "Centro comercial Moctezuma"
    }
  }
]
```

## DDoS pentest tools

### Slowloris

It is advisable to run it from a different terminal than the one where the service is running.

```sh
cd ~/Desktop
git clone https://github.com/gkbrk/slowloris.git
cd slowloris
python3 slowloris.py localhost -p 9200 -s 1000 -v
```

### GoldenEye

It is advisable to run it from a different terminal than the one where the service is running.

```sh
git clone https://github.com/jseidl/GoldenEye.git
cd ./GoldenEye/
./goldeneye.py http://localhost:9200/metrics -s 1000 -w 10 
```

## End

```sh
lambdaorm drop -e .env
docker compose -p lambdaorm-lab down
cd ..
rm -rf GoldenEye
rm -rf slowloris
```

## References

- Slowloris
  - [Install and use tutorial](https://www.youtube.com/watch?v=EccCgGuUJaA)
  - [Prueba de concepto](https://www.youtube.com/watch?v=dbOfYzcijFw)
  - [Ataque DDoS con Slowloris](https://www.youtube.com/watch?v=G_RPCkWE5jE)

- Mitigar DDOS
  - [Mitigando denegación de servicio con IPtables](https://juncotic.com/ddos-mitigando-denegacion-iptables/)
  - [Como proteger un servidor de ataques DDoS](https://www.sysadminsdecuba.com/2021/07/como-proteger-un-servidor-de-ataques-ddos/)
  - [Ataques DDoS. Recomendaciones y buenas prácticas](https://www.ccn-cert.cni.es/informes/abstracts/4925-ataques-ddos-recomendaciones-y-buenas-practicas/file.html)
    - [Cómo protegerse de un ataque DDoS](https://telefonicatech.com/blog/ddos)
  
  - [What is a DDoS Attack and How to Mitigate it](https://www.loginradius.com/blog/engineering/how-to-mitigate-ddos-attack/)  
  - [HOW TO AVOID TIME-BASED DDOS ATTACKS IN NODE](https://www.nearform.com/blog/avoid-time-based-ddos-attacks-node-js/)
  - [sqlmap](https://sqlmap.org/)

  - Configuración de sysctl.conf
    - [Opciones de seguridad en el kernel /proc en GNU/Linux](https://blog.elhacker.net/2015/04/opciones-de-seguridad-de-red-en-el-kernel-gnu-linux-sysctl-conf.html)
    - [Linux Kernel /etc/sysctl.conf Security Hardening](https://www.cyberciti.biz/faq/linux-kernel-etcsysctl-conf-security-hardening/)
    - [Como mitigar ataques de tipo SYN Flood en Linux](https://www.voztovoice.org/?q=node/2976)
    - [ubuntu sysctl performance tuning](https://gist.github.com/hiqsociety/2a4c26123df181bcdd3f1a0d42c7ee03)
    - [sysctl.conf](https://easyengine.io/tutorials/linux/sysctl-conf/)
    - [DDoS protection with sysctl.conf](https://forums.centos.org/viewtopic.php?f=57&t=75746)

  - IPtables
    - [Protección DDoS mediante iptables](https://www.hackplayers.com/2016/04/proteccion-ddos-mediante-iptables.html)  

  - Node Application
    - [Mejores prácticas de producción: rendimiento y fiabilidad](https://expressjs.com/es/advanced/best-practice-performance.html)
    - [We’re under attack! 23+ Node.js security best practices](https://medium.com/@nodepractices/were-under-attack-23-node-js-security-best-practices-e33c146cb87d)
    - Rate Limiting
      - [Implement Rate Limiting](https://www.linkedin.com/pulse/mitigation-ddos-attack-from-nodejs-server-vartul-goyal/)
      - [DDoS attacks protection in Node](https://medium.com/@animirr/rate-limiting-brute-force-and-ddos-attacks-protection-in-node-js-2492c4a9249)
      - Express Rate Limit
        - [npm](https://www.npmjs.com/package/express-rate-limit)
        - [How to prevent a DDoS attack (or a Brute-force attack)](https://www.youtube.com/watch?v=TtPsUq09OZU)
      - node-rate-limiter-flexible
        - [github](https://github.com/animir/node-rate-limiter-flexible)
  - Ngrok
    - [tutorial rápido](https://www.youtube.com/watch?v=NqCYquO3byk)
    - [NGROK - Como exponer tu aplicación en localhost (con SSL GRATIS)](https://www.youtube.com/watch?v=frvY3Ywxs-I)  
    - [Configuración de Certificado Digital con NGROK](https://www.youtube.com/watch?v=Bw5sVqXA2aA)
  - Load Balancer
    - [Using multiple nodes](https://socket.io/docs/v4/using-multiple-nodes)
    - [Nginx and SSL in Docker Compose](https://medium.com/geekculture/webapp-nginx-and-ssl-in-docker compose-6d02bdbe8fa0)
    - NgInx load balancer
      - [Load Balancing using docker compose](https://medium.com/@vinodkrane/microservices-scaling-and-load-balancing-using-docker compose-78bf8dc04da9)
      - [multiple instances](https://pspdfkit.com/blog/2018/how-to-use-docker compose-to-run-multiple-instances-of-a-service-in-development/)  
  - Keycloak and Nginx
    - [Running Keycloak behind a Reverse Proxy](https://www.youtube.com/watch?v=MFqdgUcr2-A)
    - [example](https://github.com/jinnerbichler/keycloak-nginx/blob/master/docker compose.yml)
    - [How to Dockerize your Keycloak set up with nginx reverse proxy](https://ishanul.medium.com/how-to-dockerize-your-keycloak-set-up-with-nginx-reverse-proxy-2f78f6260147)
    - [example](https://stackoverflow.com/questions/74366273/keycloak-in-docker-with-proxy-such-as-nginx-using-non-standard-ports)
  - Mitigating DDoS Attacks with NGINX
    - [Using NGINX to prevent DDoS Attacks](https://inmediatum.com/en/blog/engineering/ddos-attacks-prevention-nginx/)
    - [Mitigating DDoS Attacks](https://www.nginx.com/blog/mitigating-ddos-attacks-with-nginx-and-nginx-plus/)
    - [DDoS attacks prevention with Nginx](https://inmediatum.com/en/blog/engineering/ddos-attacks-prevention-nginx/)
    - [How to prevent DDoS attacks using nginx](https://github.com/icon-project/documentation/blob/master/node/p-rep/how-to-using-nginx-to-prevent-DDoS-attacks.md)
    - [DDoS Protection With Nginx](https://ddos-guard.net/en/blog/ddos-protection-with-nginx)
  - Redes con docker compose
    - [redes](https://iesgn.github.io/curso_docker_2021/sesion5/redes.html)
    - [networking]( https://docs.docker.com/compose/networking/)
  - Docker Network
    - [NETWORKING EN DOCKER!](https://www.youtube.com/watch?v=BNHNMoSJz4g)
